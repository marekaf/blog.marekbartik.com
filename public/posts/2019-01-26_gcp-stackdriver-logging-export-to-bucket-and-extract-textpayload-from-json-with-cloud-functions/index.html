<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.59.0" />
	
	<title>GCP Stackdriver Logging export to bucket and extract textPayload from json with Cloud Functions | Marek Bartík | blog</title>
	
	

	<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://blog.marekbartik.com/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/images/1.png"/>

<meta name="twitter:title" content="GCP Stackdriver Logging export to bucket and extract textPayload from json with Cloud Functions"/>
<meta name="twitter:description" content="Stackdriver Logging can get expensive. Sometimes you don’t need to query/store all your application logs in Stackdriver, especially dev logs. Or you simply don’t like Stackdriver (wink wink)."/>

	<meta property="og:title" content="GCP Stackdriver Logging export to bucket and extract textPayload from json with Cloud Functions" />
<meta property="og:description" content="Stackdriver Logging can get expensive. Sometimes you don’t need to query/store all your application logs in Stackdriver, especially dev logs. Or you simply don’t like Stackdriver (wink wink)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.marekbartik.com/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/" />

<meta property="og:image" content="http://blog.marekbartik.com/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/images/1.png" />

<meta property="og:image" content="http://blog.marekbartik.com/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/images/2.png" />
<meta property="article:published_time" content="2019-01-26T16:20:44+00:00" />
<meta property="article:modified_time" content="2020-01-07T09:02:42+01:00" />


	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
	 crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	<link href="/css/medium.css" rel="stylesheet">
	<link href="/css/additional.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container pr-0">
        
        <a class="navbar-brand" href="http://blog.marekbartik.com//">

            
            <span style="font-family:Righteous;">Marek Bartík | blog</span>
            
        </a>
        

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/posts">Blog</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/separate">Separate</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/">About Me</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/static/imprint">Imprint</a>
                </li>
                
            </ul>
        </div>
        
    </div>
</nav>


        <div class="site-content">   
            <div class="container">
<div class="mainheading">
    <h1 class="sitetitle">Marek Bartík | blog</h1>
    <p class="lead">
         the clean blog!
    </p>
</div><div class="main-content">
        
        <div class="container">
            <div class="row">
                
                <div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
    <p>Share</p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=GCP%20Stackdriver%20Logging%20export%20to%20bucket%20and%20extract%20textPayload%20from%20json%20with%20Cloud%20Functions&url=http%3a%2f%2fblog.marekbartik.com%2fposts%2f2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=http%3a%2f%2fblog.marekbartik.com%2fposts%2f2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions%2f" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>

        <li class="ml-1 mr-1">
        <a target="_blank" href="https://www.xing.com/spi/shares/new?url=http%3a%2f%2fblog.marekbartik.com%2fposts%2f2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions%2f" onclick="window.open(this.href, 'xing-share', 'width=550,height=435');return false;">
        <i class="fab fa-xing"></i>
        </a>
        </li>        
    </ul>

    
</div>
</div>
                                
                <div class="col-md-9 flex-first flex-md-unordered">
                    <div class="mainheading">
                        	
                        
                        
                                                
                        
                        <h1 class="posttitle">GCP Stackdriver Logging export to bucket and extract textPayload from json with Cloud Functions</h1> 
                    </div>

                    
                    
                    
                    

                    
                    <div class="article-post">
                        

<p>Stackdriver Logging can get expensive. Sometimes you don’t need to query/store all your application logs in Stackdriver, especially dev logs. Or you simply don’t like Stackdriver (wink wink). On GCP you can export your logs to Google Storage Bucket automatically. Every hour there is a json file containing your logs and its metadata. What if you need just the raw logs though?With Stackdriver Logging you pay for log ingestion. There’s also <a href="https://cloud.google.com/logging/quotas#logs_retention_periods">log retention of 30 days only</a>! What if I want to store my logs for longer time? What if I don’t want to pay so much for my dev logs? What if I’m using a different tools for log analysis?</p>

<p>Stackdriver Logging has two additional services for this: Export and Exlusions. See the diagram below:</p>

<p><img src="/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/images/1.png" alt="image" /></p>

<p>Google Cloud Platform Logging Architecture, source: <a href="https://cloud.google.com/logging/docs/export/">https://cloud.google.com/logging/docs/export/</a></p>

<h3 id="stackdriver-logging-exclusions">Stackdriver Logging Exclusions</h3>

<p>You can exclude logs based on their resource type or write more complex exclusion queries like:
&gt; resource.type=”container”<br />
&gt; AND labels.”container.googleapis.com/namespace_name”=”devel”<br />
&gt; AND severity &gt; INFO</p>

<p>this excludes all GKE container logs from k8s namespace called “devel” that have severity greater than INFO (basically here just everything from stderr)</p>

<p>And you can set to exclude just 99% of those logs to be discarded! (or any other number from 0–100%).</p>

<h3 id="stackdriver-logging-exports">Stackdriver Logging Exports</h3>

<p>The great thing about this architecture is, that Exports are independent of Exclusions. If I want to Export some logs to BigQuery or Bucket I can let them to be ingested by Stackdriver at the same time or Exclude them to save some money. So creating an Exclusion does not affect my Exports and that’s pretty dope.</p>

<p>Exports are either batch or streamed. Export to bucket is batched (every hour one file named with the timestamp is created) and this can’t be changed afaik. Exports to BigQuery and Pub/Sub are streamed. You will pay for the streamed volume to BigQuery or Pub/Sub pricing accordingly. In Either case you will pay for the storage as well.</p>

<h3 id="export-logs-to-google-storage-bucket">Export logs to Google Storage Bucket</h3>

<p>When you create an automatic export of your logs to a bucket, you can expect two things:</p>

<p>Delay: around 10:10am you’ll get logs collected in time window of 9:00–10:00am and there’s nothing to guarantee that delivery time, sometimes it gets delayed even more. Not suitable for (near-)realtime log processing.</p>

<p>Log format: each line looks like this
&gt; {“insertId”:”9pxrl4ffvybrn”,”labels”:{“compute.googleapis.com/resource_name”:”fluentd-gcp-v3.1.0–2bmxq”,”container.googleapis.com/namespace_name”:”prod”,”container.googleapis.com/pod_name”:”my-app-6b495f4d8b-9l2gb”,”container.googleapis.com/stream”:”stdout”},”logName”:”projects/my-project/logs/my-app”,”receiveTimestamp”:”2019–01–26T00:00:02.198052458Z”,”resource”:{“labels”:{“cluster_name”:”prod-cluster”,”container_name”:”myapp”,”instance_id”:”4164682295655914646&#34;,”namespace_id”:”prod”,”pod_id”:”my-app-6b495f4d8b-9l2gb”,”project_id”:”my-project”,”zone”:”europe-west1-b”},”type”:”container”},”severity”:”INFO”,”textPayload”:”2019–01–26 01:00:00.788 INFO [:] DispatcherServlet:102 — Request in 3155 ms: /my/endpoint/ : 1.2.3.4 : Mozilla/5.0 (compatible; bingbot/2.0; +<a href="http://www.bing.com/bingbot.htm)n&amp;#34;,&amp;#34;timestamp&amp;#34;:&amp;#34;2019-01-26T00:00:00Z&amp;#34;">http://www.bing.com/bingbot.htm)n&amp;#34;,&amp;#34;timestamp&amp;#34;:&amp;#34;2019-01-26T00:00:00Z&amp;#34;</a>}</p>

<p>You cannot do anything neither about the delay nor about the log format…</p>

<p>So what do we do if we want to parse out the textPayload of each json line and put that into a .txt file?</p>

<h3 id="processing-the-exported-logs-with-cloud-functions">Processing the exported logs with Cloud Functions</h3>

<p>You can use <a href="https://cloud.google.com/functions/">Cloud Functions</a> to process the exported log file in the bucket.</p>

<p>Use the<code>--trigger-event google.storage.object.finalize</code> to execute the Cloud Function when this event on a particular bucket happens. This basically means that changing any file in some bucket will create this event and Cloud Function will consume that event and fire up a function to process it. For other <a href="https://cloud.google.com/functions/features/">supported event sources see the documentation</a>.</p>

<p>We will use nodejs-6 runtime for the Cloud Function.
`&#39;use strict&#39;;</p>

<p>const path = require(&#39;path&#39;);<br />
const fs = require(&#39;fs&#39;);<br />
const Storage = require(&#39;@google-cloud/storage&#39;);<br />
const readline = require(&#39;readline&#39;);</p>

<p>const DEST_BUCKET_NAME = process.env.DEST_BUCKET_NAME;</p>

<p>// Instantiates a client<br />
const storage = Storage();`</p>

<p>We initialized some global vars and imported libs to work with Google Cloud Storage</p>

<p>Next, we will define some helper functions:
`function getFileStream (file) {<br />
  if (!file.bucket) {<br />
    throw new Error(&#39;Bucket not provided. Make sure you have a &#34;bucket&#34; property in your request&#39;);<br />
  }<br />
  if (!file.name) {<br />
    throw new Error(&#39;Filename not provided. Make sure you have a &#34;name&#34; property in your request&#39;);<br />
  }</p>

<p>return storage.bucket(file.bucket).file(file.name).createReadStream();<br />
}`</p>

<p>Finally the main function:
`exports.logTransformer = (event, callback) =&gt; {<br />
  const file = event.data;</p>

<p>const filePath = file.name; // File path in the bucket.<br />
  const contentType = file.contentType; // File content type.</p>

<p>const destBucket = storage.bucket(DEST_BUCKET_NAME);</p>

<p>// Get the file name.<br />
  const fileName = path.basename(filePath);</p>

<p>const options = {<br />
    input: getFileStream(file)<br />
  };</p>

<p>// the output is no longer application/json but text/plain<br />
  const metadata = {<br />
    contentType: &#34;text/plain&#34;,<br />
  };</p>

<p>const logStream = fs.createWriteStream(&#39;/tmp/log.txt&#39;, {flags: &#39;w&#39;, encoding: &#39;utf-8&#39;});</p>

<p>logStream.on(&#39;open&#39;, function() {</p>

<pre><code>readline.createInterface(options)  
.on(&amp;#39;line&amp;#39;, (line) =&amp;gt; {  

    const clonedData = JSON.parse(line.replace(/\r?\n|\r/g, &amp;#34; &amp;#34;));  
    logStream.write(clonedData.textPayload.toString());   

})  
.on(&amp;#39;close&amp;#39;, () =&amp;gt; {  
  logStream.end(function () { console.log(&amp;#39;logstream end&amp;#39;); });  

});  
</code></pre>

<p>}).on(&#39;finish&#39;, () =&gt; {</p>

<pre><code> // We replace the .json suffix with .txt   
 const thumbFileName = fileName.replace(&amp;#39;.json&amp;#39;,&amp;#39;.txt&amp;#39;);  
 const thumbFilePath = path.join(path.dirname(filePath), thumbFileName);  

// Uploading the thumbnail.  
destBucket.upload(&amp;#39;/tmp/log.txt&amp;#39;, {  
  destination: thumbFilePath,  
  metadata: metadata,  
  resumable: false  
});  

callback();  
</code></pre>

<p>});<br />
};`</p>

<p>And that’s about it! Save that to index.js a don’t forget to include dependencies in package.json.</p>

<h3 id="deploy-it">Deploy it</h3>

<p>Simply deploy it via gcloud CLI
``SOURCE_BUCKET_NAME=my-bucket-exported-logs<br />
DEST_BUCKET_NAME=my-bucket-exported-logs-nojson</p>

<p>gcloud beta functions deploy logTransformer \<br />
   &ndash;set-env-vars DEST_BUCKET_NAME=&#34;$DEST_BUCKET_NAME&#34; \<br />
   &ndash;runtime nodejs6 \<br />
   &ndash;region europe-west1 \<br />
   &ndash;memory 128MB  \<br />
   &ndash;trigger-resource &#34;$SOURCE_BUCKET_NAME&#34; \<br />
   &ndash;trigger-event google.storage.object.finalize``</p>

<p><img src="/posts/2019-01-26_gcp-stackdriver-logging-export-to-bucket-and-extract-textpayload-from-json-with-cloud-functions/images/2.png" alt="image" /></p>

<p>Cloud Functions come with handy out-of-box monitoring dashboard — Execution Time here</p>

<p>Don’t forget to check the ‘View Logs’ (if you didn’t exclude them of course) for troubleshooting.</p>

<p>This month we’ve processed 14GiB with it so far and it’s still covered by the free tier Cloud Functions usage ❤</p>

<p>Source code: <a href="https://github.com/marekaf/gcp-stackdriver-logging-extract-textpayload/blob/master/README.md">https://github.com/marekaf/gcp-stackdriver-logging-extract-textpayload</a></p>

                    </div>
                    
                    
                    <div class="after-post-tags">
                        <ul class="tags">
                        
                        </ul>
                    </div>
                    
                    
                    
                    <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
                    
                        <a class="d-block col-md-6" href="http://blog.marekbartik.com/posts/2019-04-05_google-kubernetes-enginehorizontalpodautoscaler-with-external-metrics-from-pubsub/"> &laquo; Google Kubernetes Engine — HorizontalPodAutoscaler with external metrics from PubSub</a>
                    
                    
                        <a class="d-block col-md-6 text-lg-right" href="http://blog.marekbartik.com/posts/2018-06-29_kubernetes-in-production-poddisruptionbudget/">Kubernetes in production — PodDisruptionBudget &raquo;</a>
                    
                    <div class="clearfix"></div>
                    </div>
                    
                </div>
                
            </div>
        </div>
        
        
    </div>


            </div>
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
			<div class="d-md-flex align-items-center justify-content-center h-100">
				<h2 class="d-md-block d-none align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
			</div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
			
		</div>
	</div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Marek Bartík - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" rel="noopener" href="https://www.wowthemes.net">Mediumish Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>


        </div>


<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="/js/mediumish.js"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-42148466-5', 'auto');
	
	ga('send', 'pageview');
}
</script>

    </body>
</html>
